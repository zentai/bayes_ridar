<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Map with Multiple Points</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCssd8F37O1YosY8k0b4lUBmOTLsqGICUo&libraries=places"></script>
    <script>


     var map;
     var radius;
     var placeTypes;
     var radiusCircle;
     var gpsMarker;
     var placeMarkers = [];
     var placesService;

     async function initMap() {
      const { Map } = await google.maps.importLibrary("maps");
      const { AdvancedMarkerElement, PinElement } = await google.maps.importLibrary(
        "marker",
      );
      var queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      const gpsString = urlParams.get('gps');
      var urLat = "";
      var urLng = "";
      let locations = [];


      var dropdown1 = document.getElementById("radius");
      dropdown1.addEventListener("change", function() {
          const selectedValue = dropdown1.value;
          console.log("Selected option:", selectedValue);
          radius = parseInt(selectedValue);
          getLocation();
      });

      var dropdown2 = document.getElementById("places");
      dropdown2.addEventListener("change", function() {
          const selectedValue2 = dropdown2.value;
          console.log("Selected option:", selectedValue2);
          performPlaceSearch(selectedValue2);
      });



      if (gpsString) {
      // Split the GPS string by ";" to get each set of coordinates
        locations = gpsString.split(";").map(coord => {
        // Split each set of coordinates by ","
        const [lat, lng, altitude] = coord.split(",");
        return { lat: parseFloat(lat), lng: parseFloat(lng), altitude: parseFloat(altitude) };
      });


      }
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 15, 
          center: locations[0] 
        });
        placesService = new google.maps.places.PlacesService(map);
        console.log(locations);
        // Loop through the array and add a marker for each location
        // Loop through each point and create a circle
        locations.forEach((point,index) => {
          new google.maps.Circle({
            strokeColor: "#FF0000",
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: "#FF0000",
            fillOpacity: 0.0,
            map: map,
            center: { lat: point.lat, lng: point.lng },
            radius: point.altitude,  // Radius specific to each point
          });

          if (index+1 < locations.length ) {
            new google.maps.Marker({
              position: { lat: point.lat, lng: point.lng },
              map: map,
              title: `Point ${index + 1}`,  // Customize marker title
            });
          } else {

            const svgMarker = {
              path: "M-1.547 12l6.563-6.609-1.406-1.406-5.156 5.203-2.063-2.109-1.406 1.406zM0 0q2.906 0 4.945 2.039t2.039 4.945q0 1.453-0.727 3.328t-1.758 3.516-2.039 3.070-1.711 2.273l-0.75 0.797q-0.281-0.328-0.75-0.867t-1.688-2.156-2.133-3.141-1.664-3.445-0.75-3.375q0-2.906 2.039-4.945t4.945-2.039z",
              fillColor: "green",
              fillOpacity: 0.6,
              strokeWeight: 0,
              rotation: 0,
              scale: 2,
              anchor: new google.maps.Point(0, 20),
            };
            new google.maps.Marker({
              position: { lat: point.lat, lng: point.lng },
              icon: svgMarker,
              map: map,
              scale: 5,
              title: `Point ${index + 1}`,  // Customize marker title
            });

          }


        });
      } 

        function getLocation() {
            // Check if the Geolocation API is available
            if (navigator.geolocation) {
                // Request the current position
                navigator.geolocation.getCurrentPosition(showPosition, showError, {
                  enableHighAccuracy: true,
                  maximumAge: 0   // Do not use cached position
                });
            } else {
                document.getElementById("location-output").innerText = "Geolocation is not supported by this browser.";
            }
        }
        
        function showPosition(position) {
            // Get latitude and longitude
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            urLat = position.coords.latitude;
            urLng = position.coords.longitude;

            if (map) {

                const svgMarker = {
                  path: "M-1.547 12l6.563-6.609-1.406-1.406-5.156 5.203-2.063-2.109-1.406 1.406zM0 0q2.906 0 4.945 2.039t2.039 4.945q0 1.453-0.727 3.328t-1.758 3.516-2.039 3.070-1.711 2.273l-0.75 0.797q-0.281-0.328-0.75-0.867t-1.688-2.156-2.133-3.141-1.664-3.445-0.75-3.375q0-2.906 2.039-4.945t4.945-2.039z",
                  fillColor: "orange",
                  fillOpacity: 0.6,
                  strokeWeight: 0,
                  rotation: 0,
                  scale: 2,
                  anchor: new google.maps.Point(0, 20),
                };


                if (!radiusCircle) {
                     gpsMarker = new google.maps.Marker({
                                  position: { lat: urLat, lng: urLng },
                                  icon: svgMarker,
                                  map: map,
                                  scale: 5,
                                  title: `Point`,  // Customize marker title
                                });
                    radiusCircle = new google.maps.Circle({
                      strokeColor: "orange",
                      strokeOpacity: 0.8,
                      strokeWeight: 2,
                      fillColor: "orange",
                      fillOpacity: 0.0,
                      map: map,
                      center: { lat: urLat, lng: urLng },
                      radius: radius?? 300,  // Radius specific to each point
                    });
                } else {
                  gpsMarker.setPosition({ lat: urLat, lng: urLng });
                  radiusCircle.setRadius(radius)
                }

                const newLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                map.setCenter(newLocation);
                // document.getElementById("location-output").value = `Latitude: ${latitude}, Longitude: ${longitude}`;

                document.getElementById("location-output").value = `${latitude}, ${longitude}`;
            }

        }
        function showError(error) {
            console.log(error)
        }

        function performPlaceSearch(placeName) {
            // Define the request for PlacesService
            const request = {
                location: map.getCenter(),  // Use current center of the map
                radius: 1000,               // Search radius in meters
                type: [placeName],       // Type of place to search for (e.g., "restaurant", "store", etc.)
            };

            // Use the PlacesService to perform a nearby search
            placesService.nearbySearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    clearMarkers();  // Clear existing markers
                    results.forEach(place => {
                        if (place.geometry && place.geometry.location) {
                            addMarker(place);
                        }
                    });
                } else {
                    console.error("Places search failed with status:", status);
                }
            });
        }

        function clearMarkers() {
          if (placeMarkers.length > 0 ) {
              placeMarkers.forEach(marker => marker.setMap(null));  // Remove each marker from the map
              placeMarkers = [];  // Clear the markers array
          }

        }
                // Function to add a marker for each place found
        function addMarker(place) {
          const marker = new google.maps.Marker({
                map: map,
                position: place.geometry.location,
                title: place.name,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 7,
                    fillColor: "black",
                    fillOpacity: 0.6,
                    strokeWeight: 0
                },
            });
            placeMarkers.push(marker);  // Store marker for potential clearing later

            // Optional: Add an info window for each marker
            const infoWindow = new google.maps.InfoWindow({
                content: `<strong>${place.name}</strong><br>${place.vicinity}`
            });
            marker.addListener("click", () => {
                infoWindow.open(map, marker);
            });
        }
    </script>
    <style>
      /* Set the size of the map */
      #map {
        height: 900px;
        width: 100%;
      }

      .container1 {
        display: flex; /* or inline-flex */
      }
      .container1 div{
        width: 300px; /* or inline-flex */
      }
    </style>
  </head>
  <body onload="initMap()">
    <div >
      <div class="container1">
          <div>
            <button onclick="getLocation()">Load</button>
          </div>
          <div>
            <select id="radius">
              <option value="5">5</option>
              <option value="10">10</option>
              <option value="30">30</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="300">300</option>
            </select>
          </div>
          <div>
            <select id="places">
              <option value="establishment">establishment</option>
              <option value="restaurant">restaurant</option>
              <option value="cafe">cafe</option>
              <option value="bar">bar</option>
              <option value="store">store</option>
              <option value="bank">bank</option>
              <option value="park">park</option>
              <option value="bus_station">bus_station</option>
              <option value="lodging">lodging</option>
              <option value="school">school</option>
              <option value="university">university</option>
              <option value="police">police</option>
            </select>
          </div>


      </div>

    <div>


    </div>
    <div > <input id="location-output" type="text" value="">  </div>

    <h3>Map with Multiple Points</h3>
    <div id="map"></div>
  </body>
</html>